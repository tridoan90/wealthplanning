<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Wealth Planning Simulator | C√¥ng c·ª• M√¥ ph·ªèng Ho·∫°ch ƒë·ªãnh T√†i s·∫£n C√° nh√¢n</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --red: #dc2626;
            --red-dark: #991b1b;
            --red-light: #fecaca;
            --black: #0f172a;
            --grey-dark: #334155;
            --grey: #64748b;
            --grey-light: #cbd5e1;
            --bg: #f8fafc;
            --white: #ffffff;
            --green: #16a34a;
            --blue: #2563eb;
            --amber: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--black);
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--black) 0%, var(--grey-dark) 100%);
            padding: 2rem 1.5rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--grey-light);
            font-size: 0.95rem;
        }

        .lang-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s;
            z-index: 10;
        }

        .lang-toggle:hover { background: var(--red-dark); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .step {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--grey-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--red);
        }

        .step-number {
            background: var(--red);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-family: 'Crimson Pro', serif;
        }

        .step-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            color: var(--black);
        }

        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--grey-dark);
            margin-bottom: 0.4rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--grey);
            font-weight: 600;
            font-size: 0.875rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem 0.875rem;
            border: 1px solid var(--grey-light);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: 'DM Sans', sans-serif;
            background: white;
            transition: all 0.2s;
        }

        input[type="number"] { padding-left: 2.5rem; }

        input:focus, select:focus {
            outline: none;
            border-color: var(--red);
            box-shadow: 0 0 0 3px var(--red-light);
        }

        .summary-box {
            background: linear-gradient(135deg, var(--grey-dark) 0%, var(--black) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
        }

        .summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.8125rem;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Crimson Pro', serif;
        }

        .tier-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tier-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--grey-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .tier-option:hover { border-color: var(--red); }
        .tier-option.active {
            border-color: var(--red);
            background: var(--red-light);
        }

        .tier-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .tier-desc {
            font-size: 0.75rem;
            color: var(--grey);
        }

        .allocation-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--grey-light);
            margin-bottom: 0.75rem;
        }

        .allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .allocation-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .allocation-yield {
            font-size: 0.75rem;
            color: var(--grey);
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .allocation-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--grey-light);
            outline: none;
        }

        .allocation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
        }

        .allocation-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--red);
            cursor: pointer;
            border: none;
        }

        .allocation-value {
            text-align: right;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--red);
            margin-top: 0.25rem;
        }

        .goal-item {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--grey-light);
            margin-bottom: 1rem;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .goal-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .goal-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .status-possible { background: #d1fae5; color: var(--green); }
        .status-impossible { background: var(--red-light); color: var(--red); }

        .goal-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .btn {
            background: linear-gradient(135deg, var(--red), var(--red-dark));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(220, 38, 38, 0.3);
        }

        .results {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--grey-light);
        }

        .result-label {
            font-size: 0.8125rem;
            color: var(--grey);
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'Crimson Pro', serif;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--grey-light);
        }

        .chart-wrapper {
            height: 400px;
            margin-top: 1rem;
        }

        .hidden { display: none; }

        .vi { display: none; }
        body.lang-vi .en { display: none; }
        body.lang-vi .vi { display: block; }

        @media (max-width: 968px) {
            .grid2, .grid3, .summary-grid, .results { grid-template-columns: 1fr; }
            .goal-fields { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="lang-en">
    <div class="header">
        <button class="lang-toggle" onclick="toggleLang()">
            <span class="en">üáªüá≥ Ti·∫øng Vi·ªát</span>
            <span class="vi">üá¨üáß English</span>
        </button>
        <h1>
            <span class="en">Wealth Management Simulator</span>
            <span class="vi">M√¥ Ph·ªèng Qu·∫£n L√Ω T√†i Ch√≠nh</span>
        </h1>
        <p>
            <span class="en">Personal planning tool powered by VinaCapital</span>
            <span class="vi">C√¥ng c·ª• Ho·∫°ch ƒë·ªãnh T√†i ch√≠nh C√° nh√¢n ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi VinaCapital</span>
        </p>
    </div>

    <div class="container">
        <!-- STEP 1: ASSETS & LIABILITIES -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2 class="step-title">
                    <span class="en">Assets & Liabilities</span>
                    <span class="vi">T√†i S·∫£n & N·ª£</span>
                </h2>
            </div>

            <div class="grid2">
                <div>
                    <h3 style="margin-bottom: 1rem; color: var(--grey-dark);">
                        <span class="en">üí∞ Assets</span>
                        <span class="vi">üí∞ T√†i S·∫£n</span>
                    </h3>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Cash and Bank Deposits</span>
                            <span class="vi">Ti·ªÅn m·∫∑t v√† ti·ªÅn g·ª≠i ng√¢n h√†ng</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="cash" value="80,000,000" data-value="80000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Real Estate</span>
                            <span class="vi">B·∫•t ƒë·ªông s·∫£n</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="realestate" value="3,500,000,000" data-value="3500000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Other Self-Investments (Gold, Stocks, Bonds...)</span>
                            <span class="vi">ƒê·∫ßu t∆∞ c√° nh√¢n kh√°c (V√†ng, C·ªï phi·∫øu, Tr√°i phi·∫øu...)</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="bank" value="200,000,000" data-value="200000000">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 style="margin-bottom: 1rem; color: var(--grey-dark);">
                        <span class="en">üí≥ Liabilities / Debt</span>
                        <span class="vi">üí≥ N·ª£</span>
                    </h3>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Total Current Debt</span>
                            <span class="vi">T·ªïng d∆∞ n·ª£ hi·ªán t·∫°i</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="total-debt" value="600,000,000" data-value="600000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Debt Interest Rate (% p.a.)</span>
                            <span class="vi">L√£i su·∫•t n·ª£ (%/nƒÉm)</span>
                        </label>
                        <input type="number" id="debt-rate" value="9.0" step="0.1" min="0" max="30">
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Remaining Term (years)</span>
                            <span class="vi">Th·ªùi h·∫°n c√≤n l·∫°i (nƒÉm)</span>
                        </label>
                        <input type="number" id="debt-term" value="4" min="0" max="30">
                    </div>

                    <div class="input-group">
                        <label class="input-label" style="color: var(--grey);">
                            <span class="en">Monthly Debt Payment (Auto-calculated)</span>
                            <span class="vi">Tr·∫£ n·ª£ h√†ng th√°ng (T·ª± ƒë·ªông t√≠nh)</span>
                        </label>
                        <div style="padding: 0.75rem; background: var(--bg); border-radius: 8px; font-weight: 600; color: var(--red);" id="auto-debt-payment">
                            0 ‚Ç´
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-box">
                <div class="summary-title">
                    <span class="en">üìä Financial Health Summary</span>
                    <span class="vi">üìä T·ªïng Quan T√¨nh H√¨nh T√†i Ch√≠nh</span>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Total Assets</span>
                            <span class="vi">T·ªïng t√†i s·∫£n</span>
                        </div>
                        <div class="summary-value" id="total-assets">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Net Worth</span>
                            <span class="vi">T√†i s·∫£n r√≤ng</span>
                        </div>
                        <div class="summary-value" id="net-worth">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Liquid Assets</span>
                            <span class="vi">T√†i s·∫£n thanh kho·∫£n</span>
                        </div>
                        <div class="summary-value" id="liquid-assets">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: INCOME & EXPENSES -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2 class="step-title">
                    <span class="en">Income & Expenses</span>
                    <span class="vi">Thu Nh·∫≠p & Chi Ph√≠</span>
                </h2>
            </div>

            <div class="grid2">
                <div>
                    <h3 style="margin-bottom: 1rem; color: var(--grey-dark);">
                        <span class="en">üíµ Income (Monthly)</span>
                        <span class="vi">üíµ Thu Nh·∫≠p (H√†ng Th√°ng)</span>
                    </h3>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Monthly Salary (Net)</span>
                            <span class="vi">L∆∞∆°ng h√†ng th√°ng (sau thu·∫ø)</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="salary" value="72,000,000" data-value="72000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Other Income (Net)</span>
                            <span class="vi">Thu nh·∫≠p kh√°c</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="other-income" value="0" data-value="0">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 style="margin-bottom: 1rem; color: var(--grey-dark);">
                        <span class="en">üí∏ Expenses (Monthly)</span>
                        <span class="vi">üí∏ Chi Ph√≠ (H√†ng Th√°ng)</span>
                    </h3>
                    
                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Family Spending</span>
                            <span class="vi">Chi ti√™u gia ƒë√¨nh</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="family" value="25,000,000" data-value="25000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Children's Education</span>
                            <span class="vi">H·ªçc ph√≠ con c√°i</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="education-exp" value="8,000,000" data-value="8000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Insurance (Health, Life, Automobiles...)</span>
                            <span class="vi">B·∫£o hi·ªÉm (Y t·∫ø, Nh√¢n th·ªç, Xe...)</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="insurance" value="1,000,000" data-value="1000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">
                            <span class="en">Other (Travel, Entertainment, Relatives...)</span>
                            <span class="vi">Chi ph√≠ kh√°c (Du l·ªãch, Gi·∫£i tr√≠, H·ªç h√†ng...)</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-prefix">‚Ç´</span>
                            <input type="text" id="other-exp" value="2,000,000" data-value="2000000">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label" style="color: var(--grey);">
                            <span class="en">Debt Payment (Auto-calculated)</span>
                            <span class="vi">Tr·∫£ n·ª£ (T·ª± ƒë·ªông t√≠nh)</span>
                        </label>
                        <div style="padding: 0.75rem; background: var(--bg); border-radius: 8px; font-weight: 600; color: var(--grey-dark);" id="expense-debt-payment">
                            0 ‚Ç´
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-box">
                <div class="summary-title">
                    <span class="en">üìä Cash Flow Summary</span>
                    <span class="vi">üìä T·ªïng Quan D√≤ng Ti·ªÅn</span>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Total Income (Annual)</span>
                            <span class="vi">T·ªïng thu nh·∫≠p (NƒÉm)</span>
                        </div>
                        <div class="summary-value" id="total-income">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Total Expenses (Annual)</span>
                            <span class="vi">T·ªïng chi ph√≠ (NƒÉm)</span>
                        </div>
                        <div class="summary-value" id="total-expenses">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Net Cash Flow (Annual)</span>
                            <span class="vi">D√≤ng ti·ªÅn r√≤ng (NƒÉm)</span>
                        </div>
                        <div class="summary-value" id="cash-flow">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVESTMENT ALLOCATION -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">üìä</div>
                <h2 class="step-title">
                    <span class="en">Investment Portfolio Allocation</span>
                    <span class="vi">Ph√¢n B·ªï Danh M·ª•c ƒê·∫ßu T∆∞</span>
                </h2>
            </div>

            <div class="grid2" style="margin-bottom: 1.5rem;">
                <div>
                    <label class="input-label">
                        <span class="en">Investor Tier</span>
                        <span class="vi">H·∫°ng Nh√† ƒê·∫ßu T∆∞</span>
                    </label>
                    <div class="tier-selector">
                        <div class="tier-option active" onclick="selectTier('retail')" id="tier-retail">
                            <div class="tier-label">
                                <span class="en">Retail</span>
                                <span class="vi">C√° Nh√¢n</span>
                            </div>
                        </div>
                        <div class="tier-option" onclick="selectTier('professional')" id="tier-prof">
                            <div class="tier-label">
                                <span class="en">Professional</span>
                                <span class="vi">Chuy√™n Nghi·ªáp</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="input-label">
                        <span class="en">Risk Profile / Tolerance</span>
                        <span class="vi">M·ª©c ƒê·ªô R·ªßi Ro Ch·∫•p Nh·∫≠n</span>
                    </label>
                    <select id="risk-profile" onchange="applyRecommendedAllocation()">
                        <option value="highly-conservative">
                            <span class="en">Highly Conservative (R·∫•t th·∫≠n tr·ªçng)</span>
                        </option>
                        <option value="balanced" selected>
                            <span class="en">Balanced (C√¢n b·∫±ng)</span>
                        </option>
                        <option value="growth">
                            <span class="en">Growth (TƒÉng tr∆∞·ªüng)</span>
                        </option>
                        <option value="adventurous">
                            <span class="en">Adventurous (M·∫°o hi·ªÉm)</span>
                        </option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 1rem; display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
                <button class="btn" style="flex: 1; margin: 0; padding: 0.75rem;" onclick="applyRecommendedAllocation()">
                    <span class="en">üìã Apply Recommended Allocation</span>
                    <span class="vi">üìã √Åp D·ª•ng Ph√¢n B·ªï ƒê·ªÅ Xu·∫•t</span>
                </button>
                <button class="btn" style="flex: 1; margin: 0; padding: 0.75rem; background: linear-gradient(135deg, var(--grey-dark), var(--black));" onclick="resetAllocation()">
                    <span class="en">üîÑ Reset</span>
                    <span class="vi">üîÑ ƒê·∫∑t L·∫°i</span>
                </button>
            </div>

            <div id="retail-alloc">
                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üíµ Money Market Fund, Short-term Fixed Income</span>
                            <span class="vi">üíµ Qu·ªπ Th·ªã Tr∆∞·ªùng Ti·ªÅn T·ªá, Tr√°i Phi·∫øu Ng·∫Øn H·∫°n</span>
                        </span>
                        <span class="allocation-yield">5-6% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-liquidity" min="0" max="100" value="20" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-liquidity">20</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üìú Long-term Fixed Income Funds</span>
                            <span class="vi">üìú Qu·ªπ Tr√°i Phi·∫øu D√†i H·∫°n</span>
                        </span>
                        <span class="allocation-yield">8-12% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-income" min="0" max="100" value="25" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-income">25</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üìà Broad Market ETF, Sectoral/Smart-Beta ETF</span>
                            <span class="vi">üìà ETF Th·ªã Tr∆∞·ªùng, ETF Ng√†nh/Smart-Beta</span>
                        </span>
                        <span class="allocation-yield">10-20% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-growth" min="0" max="100" value="25" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-growth">25</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">‚öñÔ∏è Balanced Funds, Equity Funds</span>
                            <span class="vi">‚öñÔ∏è Qu·ªπ C√¢n B·∫±ng, Qu·ªπ C·ªï Phi·∫øu</span>
                        </span>
                        <span class="allocation-yield">10-20% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-balanced" min="0" max="100" value="15" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-balanced">15</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üõ°Ô∏è Retirement Plan / LTSP</span>
                            <span class="vi">üõ°Ô∏è K·∫ø Ho·∫°ch H∆∞u Tr√≠ / LTSP</span>
                        </span>
                        <span class="allocation-yield">10-15% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-retirement" min="0" max="100" value="10" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-retirement">10</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üè• Protection / Insurance-linked</span>
                            <span class="vi">üè• B·∫£o V·ªá / Li√™n K·∫øt B·∫£o Hi·ªÉm</span>
                        </span>
                        <span class="allocation-yield">3.0% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-protection" min="0" max="100" value="5" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-protection">5</span>%</div>
                </div>
            </div>

            <div id="prof-alloc" class="hidden">
                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üè¢ Alternatives (Private Markets)</span>
                            <span class="vi">üè¢ ƒê·∫ßu T∆∞ Thay Th·∫ø (Th·ªã Tr∆∞·ªùng Ri√™ng)</span>
                        </span>
                        <span class="allocation-yield">8-14% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-alternatives" min="0" max="100" value="0" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-alternatives">0</span>%</div>
                </div>

                <div class="allocation-item">
                    <div class="allocation-header">
                        <span class="allocation-name">
                            <span class="en">üé≤ Opportunistic / Diversifiers</span>
                            <span class="vi">üé≤ C∆° H·ªôi / ƒêa D·∫°ng H√≥a</span>
                        </span>
                        <span class="allocation-yield">5-12% p.a.</span>
                    </div>
                    <input type="range" class="allocation-slider" id="alloc-opportunistic" min="0" max="100" value="0" oninput="updateAlloc()">
                    <div class="allocation-value"><span id="val-opportunistic">0</span>%</div>
                </div>
            </div>

            <div class="summary-box" style="margin-top: 1rem;">
                <div class="summary-title">
                    <span class="en">üìä Portfolio Summary & Risk Metrics</span>
                    <span class="vi">üìä T·ªïng Quan Danh M·ª•c & R·ªßi Ro</span>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Total Allocation</span>
                            <span class="vi">T·ªïng ph√¢n b·ªï</span>
                        </div>
                        <div class="summary-value" id="total-alloc-display" style="font-size: 1.5rem;">100%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Expected Yield</span>
                            <span class="vi">L·ª£i su·∫•t k·ª≥ v·ªçng</span>
                        </div>
                        <div class="summary-value" id="blended-yield-display">6.8%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Portfolio Risk</span>
                            <span class="vi">R·ªßi ro danh m·ª•c</span>
                        </div>
                        <div class="summary-value" id="portfolio-risk">Medium</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Volatility Est.</span>
                            <span class="vi">Bi·∫øn ƒë·ªông ∆∞·ªõc t√≠nh</span>
                        </div>
                        <div class="summary-value" id="volatility">8.5%</div>
                    </div>
                </div>
                <div id="allocation-warning" class="hidden" style="margin-top: 1rem; padding: 0.75rem; background: rgba(220, 38, 38, 0.1); border-radius: 6px; text-align: center; color: var(--red); font-weight: 600;">
                    <span class="en">‚ö†Ô∏è Total allocation must equal 100%</span>
                    <span class="vi">‚ö†Ô∏è T·ªïng ph√¢n b·ªï ph·∫£i b·∫±ng 100%</span>
                </div>
            </div>
        </div>

        <!-- STEP 3: GOALS -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2 class="step-title">
                    <span class="en">Life Goals & Financial Planning</span>
                    <span class="vi">M·ª•c Ti√™u Cu·ªôc S·ªëng & K·∫ø Ho·∫°ch T√†i Ch√≠nh</span>
                </h2>
            </div>

            <div class="grid2" style="margin-bottom: 1.5rem;">
                <div class="input-group">
                    <label class="input-label">
                        <span class="en">Start Age / Current Age</span>
                        <span class="vi">Tu·ªïi b·∫Øt ƒë·∫ßu / Tu·ªïi hi·ªán t·∫°i</span>
                    </label>
                    <input type="number" id="start-age" value="45" min="18" max="100">
                </div>
                <div class="input-group">
                    <label class="input-label">
                        <span class="en">Expected Inflation Rate (%)</span>
                        <span class="vi">L·∫°m ph√°t k·ª≥ v·ªçng (%)</span>
                    </label>
                    <input type="number" id="inflation-rate" value="4.0" min="0" max="20" step="0.1">
                </div>
            </div>

            <div id="goals-container">
                <!-- Goal 1 -->
                <div class="goal-item">
                    <div class="goal-header">
                        <span class="goal-name">
                            <span class="en">üéì Goal 1: Children Studying Abroad</span>
                            <span class="vi">üéì M·ª•c ti√™u 1: Con C√°i Du H·ªçc</span>
                        </span>
                        <span class="goal-status status-possible" id="status-1">
                            <span class="en">Calculating...</span>
                            <span class="vi">ƒêang t√≠nh...</span>
                        </span>
                    </div>
                    <div class="goal-fields">
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Years from Now</span>
                                <span class="vi">S·ªë nƒÉm t·ª´ b√¢y gi·ªù</span>
                            </label>
                            <input type="number" id="goal1-years" value="12" min="0" max="50">
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Required Amount (VND)</span>
                                <span class="vi">S·ªë ti·ªÅn c·∫ßn (VND)</span>
                            </label>
                            <div class="input-wrapper">
                                <span class="input-prefix">‚Ç´</span>
                                <input type="text" id="goal1-amount" value="1,200,000,000" data-value="1200000000">
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Custom Name (Optional)</span>
                                <span class="vi">T√™n t√πy ch·ªânh</span>
                            </label>
                            <input type="text" id="goal1-name" placeholder="Children Studying Abroad">
                        </div>
                    </div>
                </div>

                <!-- Goal 2 -->
                <div class="goal-item">
                    <div class="goal-header">
                        <span class="goal-name">
                            <span class="en">üöó Goal 2: Buying Car</span>
                            <span class="vi">üöó M·ª•c ti√™u 2: Mua Xe</span>
                        </span>
                        <span class="goal-status status-possible" id="status-2">
                            <span class="en">Calculating...</span>
                            <span class="vi">ƒêang t√≠nh...</span>
                        </span>
                    </div>
                    <div class="goal-fields">
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Years from Now</span>
                                <span class="vi">S·ªë nƒÉm t·ª´ b√¢y gi·ªù</span>
                            </label>
                            <input type="number" id="goal2-years" value="6" min="0" max="50">
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Required Amount (VND)</span>
                                <span class="vi">S·ªë ti·ªÅn c·∫ßn (VND)</span>
                            </label>
                            <div class="input-wrapper">
                                <span class="input-prefix">‚Ç´</span>
                                <input type="text" id="goal2-amount" value="800,000,000" data-value="800000000">
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Custom Name (Optional)</span>
                                <span class="vi">T√™n t√πy ch·ªânh</span>
                            </label>
                            <input type="text" id="goal2-name" placeholder="Buying Car">
                        </div>
                    </div>
                </div>

                <!-- Goal 3: Retirement -->
                <div class="goal-item" style="border: 2px solid var(--amber);">
                    <div class="goal-header">
                        <span class="goal-name">
                            <span class="en">üå¥ Goal 3: Happy Retirement</span>
                            <span class="vi">üå¥ M·ª•c ti√™u 3: Ngh·ªâ H∆∞u H·∫°nh Ph√∫c</span>
                        </span>
                        <span class="goal-status status-possible" id="status-3">
                            <span class="en">Calculating...</span>
                            <span class="vi">ƒêang t√≠nh...</span>
                        </span>
                    </div>
                    <div class="goal-fields">
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Retirement Age</span>
                                <span class="vi">Tu·ªïi ngh·ªâ h∆∞u</span>
                            </label>
                            <input type="number" id="goal3-age" value="68" min="18" max="100">
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Life Expectancy</span>
                                <span class="vi">Tu·ªïi th·ªç d·ª± ki·∫øn</span>
                            </label>
                            <input type="number" id="life-expectancy" value="90" min="60" max="120">
                        </div>
                        <div class="input-group">
                            <label class="input-label" style="color: var(--amber);">
                                <span class="en">Required Amount (Auto: ~25x Annual Expenses + Inflation)</span>
                                <span class="vi">S·ªë ti·ªÅn c·∫ßn (T·ª± ƒë·ªông: ~25x Chi ph√≠ nƒÉm + L·∫°m ph√°t)</span>
                            </label>
                            <div style="padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; font-weight: 600; color: var(--amber); border: 1px solid var(--amber);" id="auto-retirement-amount">
                                0 ‚Ç´
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">
                                <span class="en">Custom Name (Optional)</span>
                                <span class="vi">T√™n t√πy ch·ªânh</span>
                            </label>
                            <input type="text" id="goal3-name" placeholder="Happy Retirement">
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="margin: 2rem 0 1rem 0; color: var(--grey-dark); font-size: 1.1rem;">
                <span class="en">üíº Investment Planning</span>
                <span class="vi">üíº K·∫ø Ho·∫°ch ƒê·∫ßu T∆∞</span>
            </h3>

            <div class="grid2" style="margin-bottom: 1rem;">
                <div class="input-group">
                    <label class="input-label">
                        <span class="en">One-time Investment</span>
                        <span class="vi">ƒê·∫ßu t∆∞ m·ªôt l·∫ßn</span>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-prefix">‚Ç´</span>
                        <input type="text" id="onetime-investment" value="100,000,000" data-value="100000000">
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">
                        <span class="en">Monthly Investment (% of Net Cash Flow)</span>
                        <span class="vi">ƒê·∫ßu t∆∞ h√†ng th√°ng (% D√≤ng ti·ªÅn r√≤ng)</span>
                    </label>
                    <input type="number" id="monthly-invest-pct" value="30.0" min="0" max="100" step="1">
                </div>
            </div>

            <div class="summary-box" style="margin-top: 1rem;">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Monthly Investment</span>
                            <span class="vi">ƒê·∫ßu t∆∞ h√†ng th√°ng</span>
                        </div>
                        <div class="summary-value" id="monthly-investment-amount">0 ‚Ç´</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Expected Portfolio Yield</span>
                            <span class="vi">L·ª£i su·∫•t danh m·ª•c</span>
                        </div>
                        <div class="summary-value" id="expected-yield-display">0%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">
                            <span class="en">Net Monthly Cash Flow</span>
                            <span class="vi">D√≤ng ti·ªÅn r√≤ng/th√°ng</span>
                        </div>
                        <div class="summary-value" id="net-monthly-cashflow">0 ‚Ç´</div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="calculatePlan()">
                <span class="en">üìä Calculate Complete Financial Plan</span>
                <span class="vi">üìä T√≠nh To√°n K·∫ø Ho·∫°ch T√†i Ch√≠nh Ho√†n Ch·ªânh</span>
            </button>
        </div>

        <!-- RESULTS -->
        <div class="step hidden" id="results-section">
            <div class="step-header">
                <div class="step-number">üìà</div>
                <h2 class="step-title">
                    <span class="en">Financial Plan Results</span>
                    <span class="vi">K·∫øt Qu·∫£ K·∫ø Ho·∫°ch T√†i Ch√≠nh</span>
                </h2>
            </div>

            <div class="results">
                <div class="result-card">
                    <div class="result-label">
                        <span class="en">One-time Investment</span>
                        <span class="vi">ƒê·∫ßu t∆∞ 1 l·∫ßn</span>
                    </div>
                    <div class="result-value" id="onetime-invest">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label">
                        <span class="en">Monthly Investment</span>
                        <span class="vi">ƒê·∫ßu t∆∞ ƒë·ªãnh k·ª≥/th√°ng</span>
                    </div>
                    <div class="result-value" id="monthly-invest">0</div>
                </div>
                <div class="result-card">
                    <div class="result-label">
                        <span class="en">Goals Achievable</span>
                        <span class="vi">M·ª•c ti√™u ƒë·∫°t ƒë∆∞·ª£c</span>
                    </div>
                    <div class="result-value" id="goals-achievable">0/3</div>
                </div>
                <div class="result-card">
                    <div class="result-label">
                        <span class="en">Overall Status</span>
                        <span class="vi">Tr·∫°ng th√°i t·ªïng qu√°t</span>
                    </div>
                    <div class="result-value" id="overall-status">--</div>
                </div>
            </div>

            <div class="chart-card">
                <h3 style="margin-bottom: 1rem;">
                    <span class="en">üìà Wealth Projection & Goal Milestones</span>
                    <span class="vi">üìà D·ª± B√°o T√†i S·∫£n & M·ªëc M·ª•c Ti√™u</span>
                </h3>
                <div class="chart-wrapper">
                    <canvas id="chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLang = 'en';
        let currentTier = 'retail';
        let chart = null;
        let isAdjusting = false;

        // Updated yields based on illustrative returns
        const yields = {
            liquidity: 5.5,       // Money Market Fund, Short-term Fixed Income: 5-6%
            income: 10.0,         // Long-term Fixed Income Funds: 8-12%
            growth: 15.0,         // Broad Market ETF, Sectoral/Smart-Beta ETF: 10-20%
            balanced: 15.0,       // Balanced Funds, Equity Funds: 10-20%
            retirement: 12.5,     // Retirement Plan / LTSP: 10-15%
            protection: 3.0,      // Protection / Insurance-linked: 3.0%
            alternatives: 11.0,   // Alternatives: 8-14%
            opportunistic: 8.5    // Opportunistic: 5-12%
        };

        const volatility = {
            liquidity: 2,
            income: 6,
            growth: 15,
            balanced: 12,
            retirement: 8,
            protection: 2,
            alternatives: 13,
            opportunistic: 20
        };

        const riskProfiles = {
            'highly-conservative': {
                retail: { liquidity: 40, income: 25, growth: 10, balanced: 10, retirement: 10, protection: 5 },
                professional: { liquidity: 30, income: 25, growth: 10, balanced: 10, retirement: 10, protection: 5, alternatives: 5, opportunistic: 5 }
            },
            'balanced': {
                retail: { liquidity: 20, income: 25, growth: 25, balanced: 15, retirement: 10, protection: 5 },
                professional: { liquidity: 15, income: 20, growth: 25, balanced: 15, retirement: 10, protection: 5, alternatives: 5, opportunistic: 5 }
            },
            'growth': {
                retail: { liquidity: 10, income: 20, growth: 30, balanced: 25, retirement: 10, protection: 5 },
                professional: { liquidity: 5, income: 15, growth: 30, balanced: 20, retirement: 10, protection: 5, alternatives: 10, opportunistic: 5 }
            },
            'adventurous': {
                retail: { liquidity: 5, income: 10, growth: 40, balanced: 30, retirement: 10, protection: 5 },
                professional: { liquidity: 5, income: 10, growth: 30, balanced: 25, retirement: 10, protection: 5, alternatives: 10, opportunistic: 5 }
            }
        };

        // Thousand separator formatting functions
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function setupNumberInput(input) {
            input.addEventListener('focus', function() {
                this.value = this.getAttribute('data-value') || '';
            });
            
            input.addEventListener('blur', function() {
                const val = parseFloat(this.value.replace(/,/g, '')) || 0;
                this.setAttribute('data-value', val);
                this.value = formatNumber(val);
                updateSummary();
            });
            
            input.addEventListener('input', function() {
                const val = this.value.replace(/,/g, '');
                if (!isNaN(val) && val !== '') {
                    this.setAttribute('data-value', val);
                }
            });
        }

        // Initialize all number inputs with thousand separators
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input[type="text"][data-value]').forEach(setupNumberInput);
        });

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'vi' : 'en';
            document.body.className = 'lang-' + currentLang;
            updateSummary();
            updateAlloc();
            if (chart) calculatePlan();
        }

        function selectTier(tier) {
            currentTier = tier;
            document.getElementById('tier-retail').classList.toggle('active', tier === 'retail');
            document.getElementById('tier-prof').classList.toggle('active', tier === 'professional');
            document.getElementById('prof-alloc').classList.toggle('hidden', tier === 'retail');
            
            if (tier === 'retail') {
                ['alternatives', 'opportunistic'].forEach(id => {
                    const elem = document.getElementById('alloc-' + id);
                    if (elem) {
                        elem.value = 0;
                        document.getElementById('val-' + id).textContent = 0;
                    }
                });
            }
            applyRecommendedAllocation();
        }

        function applyRecommendedAllocation() {
            const risk = document.getElementById('risk-profile').value;
            const profile = riskProfiles[risk][currentTier];
            
            isAdjusting = true;
            Object.keys(profile).forEach(key => {
                const element = document.getElementById('alloc-' + key);
                if (element) {
                    element.value = profile[key];
                    document.getElementById('val-' + key).textContent = profile[key];
                }
            });
            isAdjusting = false;
            updateAlloc();
        }

        function resetAllocation() {
            const ids = ['liquidity', 'income', 'growth', 'protection'];
            if (currentTier === 'professional') ids.push('alternatives', 'opportunistic');
            
            isAdjusting = true;
            const equal = Math.floor(100 / ids.length);
            let remaining = 100 - (equal * ids.length);
            
            ids.forEach((id, index) => {
                const val = equal + (index === 0 ? remaining : 0);
                document.getElementById('alloc-' + id).value = val;
                document.getElementById('val-' + id).textContent = val;
            });
            isAdjusting = false;
            updateAlloc();
        }

        function updateAlloc() {
            if (isAdjusting) return;
            
            const ids = ['liquidity', 'income', 'growth', 'protection'];
            if (currentTier === 'professional') ids.push('alternatives', 'opportunistic');
            
            let total = 0, weighted = 0, volatilityWeighted = 0;
            const values = {};
            
            ids.forEach(id => {
                const val = parseInt(document.getElementById('alloc-' + id).value) || 0;
                values[id] = val;
                total += val;
                weighted += val * yields[id];
                volatilityWeighted += val * volatility[id];
            });
            
            // Auto-adjust to 100% if total exceeds
            if (total > 100) {
                isAdjusting = true;
                const scale = 100 / total;
                let adjusted = 0;
                
                ids.forEach((id, index) => {
                    if (index < ids.length - 1) {
                        const newVal = Math.floor(values[id] * scale);
                        document.getElementById('alloc-' + id).value = newVal;
                        document.getElementById('val-' + id).textContent = newVal;
                        adjusted += newVal;
                    }
                });
                
                // Last item gets remainder
                const lastId = ids[ids.length - 1];
                const lastVal = 100 - adjusted;
                document.getElementById('alloc-' + lastId).value = lastVal;
                document.getElementById('val-' + lastId).textContent = lastVal;
                
                isAdjusting = false;
                updateAlloc();
                return;
            }
            
            const avgYield = total > 0 ? weighted / total : 0;
            const avgVolatility = total > 0 ? volatilityWeighted / total : 0;
            
            document.getElementById('total-alloc-display').textContent = total + '%';
            document.getElementById('total-alloc-display').style.color = total === 100 ? 'var(--green)' : 'var(--red)';
            document.getElementById('blended-yield-display').textContent = avgYield.toFixed(2) + '%';
            document.getElementById('volatility').textContent = avgVolatility.toFixed(1) + '%';
            
            // Risk assessment
            let riskLevel = 'Low';
            let riskColor = 'var(--green)';
            if (avgVolatility > 12) {
                riskLevel = currentLang === 'vi' ? 'Cao' : 'High';
                riskColor = 'var(--red)';
            } else if (avgVolatility > 7) {
                riskLevel = currentLang === 'vi' ? 'Trung b√¨nh' : 'Medium';
                riskColor = 'var(--amber)';
            } else {
                riskLevel = currentLang === 'vi' ? 'Th·∫•p' : 'Low';
            }
            
            document.getElementById('portfolio-risk').textContent = riskLevel;
            document.getElementById('portfolio-risk').style.color = riskColor;
            
            // Show warning if total != 100
            const warning = document.getElementById('allocation-warning');
            if (total !== 100) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        function updateSummary() {
            const cash = parseFormattedNumber(document.getElementById('cash').value);
            const bank = parseFormattedNumber(document.getElementById('bank').value);
            const realestate = parseFormattedNumber(document.getElementById('realestate').value);
            const debt = parseFormattedNumber(document.getElementById('total-debt').value);
            const debtRate = parseFloat(document.getElementById('debt-rate').value) || 0;
            const debtTerm = parseFloat(document.getElementById('debt-term').value) || 0;

            // Calculate monthly debt payment using amortization formula
            let monthlyDebtPayment = 0;
            if (debt > 0 && debtRate > 0 && debtTerm > 0) {
                const monthlyRate = debtRate / 100 / 12;
                const numPayments = debtTerm * 12;
                monthlyDebtPayment = debt * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            }

            // Update auto-calculated debt payment displays
            document.getElementById('auto-debt-payment').textContent = fmt(monthlyDebtPayment);
            document.getElementById('expense-debt-payment').textContent = fmt(monthlyDebtPayment);

            const totalAssets = cash + bank + realestate;
            const netWorth = totalAssets - debt;
            const liquidAssets = cash + bank;

            const salary = parseFormattedNumber(document.getElementById('salary').value);
            const otherIncome = parseFormattedNumber(document.getElementById('other-income').value);
            const family = parseFormattedNumber(document.getElementById('family').value);
            const eduExp = parseFormattedNumber(document.getElementById('education-exp').value);
            const insurance = parseFormattedNumber(document.getElementById('insurance').value);
            const otherExp = parseFormattedNumber(document.getElementById('other-exp').value);

            const totalIncome = (salary + otherIncome) * 12;
            const monthlyExpenses = family + eduExp + insurance + monthlyDebtPayment + otherExp;
            const totalExpenses = monthlyExpenses * 12;
            const cashFlow = totalIncome - totalExpenses;
            const monthlyCashFlow = cashFlow / 12;

            // Calculate retirement funding (25x annual expenses) with inflation adjustment
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value) / 100 || 0.04;
            const startAge = parseInt(document.getElementById('start-age').value) || 45;
            const retireAge = parseInt(document.getElementById('goal3-age').value) || 68;
            const yearsToRetirement = retireAge - startAge;
            
            // Adjust expenses for inflation to retirement year
            const futureAnnualExpenses = totalExpenses * Math.pow(1 + inflationRate, yearsToRetirement);
            const retirementFunding = futureAnnualExpenses * 25;
            
            document.getElementById('auto-retirement-amount').textContent = fmt(retirementFunding);

            // Calculate monthly investment amount
            const monthlyInvestPct = parseFloat(document.getElementById('monthly-invest-pct').value) || 0;
            const monthlyInvestAmount = (monthlyCashFlow * monthlyInvestPct / 100);
            
            document.getElementById('monthly-investment-amount').textContent = fmt(monthlyInvestAmount);
            document.getElementById('net-monthly-cashflow').textContent = fmt(monthlyCashFlow);

            // Calculate expected yield from allocation
            const ids = ['liquidity', 'income', 'growth', 'balanced', 'retirement', 'protection'];
            if (currentTier === 'professional') ids.push('alternatives', 'opportunistic');
            
            let totalAlloc = 0, weighted = 0;
            ids.forEach(id => {
                const val = parseInt(document.getElementById('alloc-' + id).value) || 0;
                totalAlloc += val;
                weighted += val * yields[id];
            });
            
            const expectedYield = totalAlloc > 0 ? weighted / totalAlloc : 0;
            document.getElementById('expected-yield-display').textContent = expectedYield.toFixed(2) + '%';

            document.getElementById('total-assets').textContent = fmt(totalAssets);
            document.getElementById('net-worth').textContent = fmt(netWorth);
            document.getElementById('liquid-assets').textContent = fmt(liquidAssets);
            document.getElementById('total-income').textContent = fmt(totalIncome);
            document.getElementById('total-expenses').textContent = fmt(totalExpenses);
            document.getElementById('cash-flow').textContent = fmt(cashFlow);
        }

        function fmt(val) {
            if (val >= 1000000000) return formatNumber((val/1000000000).toFixed(1)) + (currentLang === 'vi' ? ' t·ª∑ ‚Ç´' : 'B ‚Ç´');
            if (val >= 1000000) return formatNumber((val/1000000).toFixed(1)) + (currentLang === 'vi' ? ' tr ‚Ç´' : 'M ‚Ç´');
            return formatNumber(Math.round(val)) + ' ‚Ç´';
        }

        function calculatePlan() {
            updateSummary();
            
            // Check allocation is 100%
            const ids = ['liquidity', 'income', 'growth', 'balanced', 'retirement', 'protection'];
            if (currentTier === 'professional') ids.push('alternatives', 'opportunistic');
            
            let totalAlloc = 0;
            ids.forEach(id => {
                totalAlloc += parseInt(document.getElementById('alloc-' + id).value) || 0;
            });
            
            if (totalAlloc !== 100) {
                alert(currentLang === 'vi' 
                    ? 'T·ªïng ph√¢n b·ªï ph·∫£i b·∫±ng 100%. Vui l√≤ng ƒëi·ªÅu ch·ªânh!' 
                    : 'Total allocation must equal 100%. Please adjust!');
                return;
            }
            
            // Get investment inputs
            const onetimeInvest = parseFormattedNumber(document.getElementById('onetime-investment').value);
            const monthlyInvestPct = parseFloat(document.getElementById('monthly-invest-pct').value) || 0;
            
            const salary = parseFormattedNumber(document.getElementById('salary').value);
            const otherIncome = parseFormattedNumber(document.getElementById('other-income').value);
            const family = parseFormattedNumber(document.getElementById('family').value);
            const eduExp = parseFormattedNumber(document.getElementById('education-exp').value);
            const insurance = parseFormattedNumber(document.getElementById('insurance').value);
            const otherExp = parseFormattedNumber(document.getElementById('other-exp').value);
            
            // Get auto-calculated debt payment
            const debt = parseFormattedNumber(document.getElementById('total-debt').value);
            const debtRate = parseFloat(document.getElementById('debt-rate').value) || 0;
            const debtTerm = parseFloat(document.getElementById('debt-term').value) || 0;
            
            let monthlyDebtPayment = 0;
            if (debt > 0 && debtRate > 0 && debtTerm > 0) {
                const monthlyRate = debtRate / 100 / 12;
                const numPayments = debtTerm * 12;
                monthlyDebtPayment = debt * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            }
            
            const monthlyIncome = salary + otherIncome;
            const monthlyExpenses = family + eduExp + insurance + monthlyDebtPayment + otherExp;
            const monthlyCashFlow = monthlyIncome - monthlyExpenses;
            const monthlyInvest = monthlyCashFlow * monthlyInvestPct / 100;

            // Get portfolio return from allocation
            let weighted = 0;
            ids.forEach(id => {
                const val = parseInt(document.getElementById('alloc-' + id).value) || 0;
                weighted += val * yields[id];
            });
            
            const portfolioReturn = weighted / 100 / 100;

            const startAge = parseInt(document.getElementById('start-age').value);
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value) / 100 || 0.04;
            const retireAge = parseInt(document.getElementById('goal3-age').value);
            const lifeExpectancy = parseInt(document.getElementById('life-expectancy').value) || 90;
            
            // Calculate retirement funding with inflation-adjusted expenses
            const yearsToRetirement = retireAge - startAge;
            const currentFamilyExpense = family * 12; // Annual family spending only (base living expenses)
            const futureAnnualExpense = currentFamilyExpense * Math.pow(1 + inflationRate, yearsToRetirement);
            const retirementYears = lifeExpectancy - retireAge;
            
            // Calculate retirement corpus needed (sum of discounted future withdrawals)
            let retirementAmount = 0;
            for (let year = 0; year < retirementYears; year++) {
                const yearlyExpense = futureAnnualExpense * Math.pow(1 + inflationRate, year);
                const discountedValue = yearlyExpense / Math.pow(1 + portfolioReturn, year);
                retirementAmount += discountedValue;
            }
            
            const goals = [];
            
            // Goal 1 & 2: User-defined with "years from now"
            for (let i = 1; i <= 2; i++) {
                const yearsFromNow = parseInt(document.getElementById(`goal${i}-years`).value) || 0;
                const amount = parseFormattedNumber(document.getElementById(`goal${i}-amount`).value);
                if (amount > 0 && yearsFromNow >= 0) {
                    goals.push({ id: i, years: yearsFromNow, amount: amount });
                }
            }
            
            // Goal 3: Retirement (auto-calculated)
            goals.push({ id: 3, years: yearsToRetirement, amount: retirementAmount });

            // Calculate goal feasibility using correct compound interest with monthly contributions
            let achievable = 0;
            goals.forEach(g => {
                if (g.years > 0) {
                    // FV = PV(1+r)^n + PMT √ó [((1+r)^n - 1) / r]
                    const fv = onetimeInvest * Math.pow(1 + portfolioReturn, g.years) + 
                               monthlyInvest * 12 * ((Math.pow(1 + portfolioReturn, g.years) - 1) / portfolioReturn);
                    const possible = fv >= g.amount;
                    achievable += possible ? 1 : 0;
                    
                    const statusEl = document.getElementById(`status-${g.id}`);
                    if (possible) {
                        statusEl.className = 'goal-status status-possible';
                        statusEl.innerHTML = currentLang === 'vi' ? 'Kh·∫£ thi' : 'Possible';
                    } else {
                        statusEl.className = 'goal-status status-impossible';
                        statusEl.innerHTML = currentLang === 'vi' ? 'Kh√¥ng kh·∫£ thi' : 'Impossible';
                    }
                } else {
                    const statusEl = document.getElementById(`status-${g.id}`);
                    statusEl.className = 'goal-status';
                    statusEl.innerHTML = currentLang === 'vi' ? 'ƒê√£ ƒë·∫øn h·∫°n' : 'Due Now';
                }
            });

            document.getElementById('onetime-invest').textContent = fmt(onetimeInvest);
            document.getElementById('monthly-invest').textContent = fmt(monthlyInvest);
            document.getElementById('goals-achievable').textContent = `${achievable}/${goals.length}`;
            
            const statusEl = document.getElementById('overall-status');
            if (achievable === goals.length) {
                statusEl.textContent = '‚úÖ';
                statusEl.style.color = 'var(--green)';
            } else if (achievable >= goals.length * 0.6) {
                statusEl.textContent = '‚ö†Ô∏è';
                statusEl.style.color = 'var(--amber)';
            } else {
                statusEl.textContent = '‚ùå';
                statusEl.style.color = 'var(--red)';
            }

            document.getElementById('results-section').classList.remove('hidden');

            // Create chart with accurate wealth projection INCLUDING retirement withdrawal waterfall
            const maxYears = lifeExpectancy - startAge;
            const years = [];
            const wealth = [];
            const withdrawals = [];
            
            for (let year = 0; year <= maxYears; year++) {
                const age = startAge + year;
                years.push(age);
                
                let w = 0;
                
                // Accumulation phase (before retirement)
                if (year < yearsToRetirement) {
                    w = onetimeInvest * Math.pow(1 + portfolioReturn, year) + 
                        monthlyInvest * 12 * ((Math.pow(1 + portfolioReturn, year) - 1) / portfolioReturn);
                    withdrawals.push(null);
                }
                // Withdrawal phase (during retirement)
                else {
                    const retirementYear = year - yearsToRetirement;
                    
                    // Start with accumulated wealth at retirement
                    let retirementWealth = onetimeInvest * Math.pow(1 + portfolioReturn, yearsToRetirement) + 
                                          monthlyInvest * 12 * ((Math.pow(1 + portfolioReturn, yearsToRetirement) - 1) / portfolioReturn);
                    
                    // Subtract all withdrawals up to this year
                    for (let y = 0; y <= retirementYear; y++) {
                        const yearlyWithdrawal = futureAnnualExpense * Math.pow(1 + inflationRate, y);
                        const withdrawalTiming = Math.pow(1 + portfolioReturn, retirementYear - y);
                        retirementWealth -= yearlyWithdrawal * withdrawalTiming;
                    }
                    
                    w = Math.max(0, retirementWealth);
                    
                    // Show withdrawal amount for this year
                    const currentWithdrawal = futureAnnualExpense * Math.pow(1 + inflationRate, retirementYear);
                    withdrawals.push(currentWithdrawal);
                }
                
                wealth.push(w);
            }

            const ctx = document.getElementById('chart').getContext('2d');
            if (chart) chart.destroy();

            const datasets = [{
                label: currentLang === 'vi' ? 'T√†i s·∫£n t√≠ch l≈©y' : 'Accumulated Wealth',
                data: wealth,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                yAxisID: 'y'
            }];

            // Add retirement withdrawal line (negative values shown as bars)
            datasets.push({
                label: currentLang === 'vi' ? 'Chi ti√™u h∆∞u tr√≠ h√†ng nƒÉm' : 'Annual Retirement Spending',
                data: withdrawals,
                type: 'bar',
                backgroundColor: 'rgba(245, 158, 11, 0.6)',
                borderColor: '#f59e0b',
                borderWidth: 2,
                yAxisID: 'y'
            });

            // Add goal milestone points
            goals.forEach((g, i) => {
                const colors = ['#2563eb', '#16a34a', '#f59e0b'];
                const goalYear = startAge + g.years;
                datasets.push({
                    label: `Goal ${g.id} (${currentLang === 'vi' ? 'Tu·ªïi' : 'Age'} ${goalYear})`,
                    data: years.map(age => age === goalYear ? g.amount : null),
                    borderColor: colors[i],
                    backgroundColor: colors[i],
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    showLine: false,
                    yAxisID: 'y'
                });
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const label = ctx.dataset.label || '';
                                    const value = ctx.parsed.y;
                                    if (value === null) return null;
                                    return `${label}: ${fmt(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: currentLang === 'vi' ? 'T√†i s·∫£n (VND)' : 'Wealth (VND)'
                            },
                            ticks: {
                                callback: val => {
                                    if (val >= 1000000000) return formatNumber((val/1000000000).toFixed(1)) + 'B';
                                    if (val >= 1000000) return formatNumber((val/1000000).toFixed(0)) + 'M';
                                    return formatNumber(val);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: currentLang === 'vi' ? 'Tu·ªïi' : 'Age'
                            }
                        }
                    }
                }
            });

            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-update on input
        document.querySelectorAll('input').forEach(input => {
            if (input.type === 'text' && input.hasAttribute('data-value')) {
                // Already handled by setupNumberInput
                return;
            } else if (input.type === 'range') {
                input.addEventListener('input', updateAlloc);
            } else if (input.type === 'number') {
                input.addEventListener('input', updateSummary);
            }
        });

        // Initialize
        setTimeout(() => {
            updateAlloc();
            updateSummary();
        }, 100);
    </script>
</body>
</html>
